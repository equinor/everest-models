# spinningjenny 
[![Spinningjenny](https://github.com/equinor/spinningjenny/workflows/Testing/badge.svg)](https://github.com/equinor/spinningjenny/actions?query=workflow%3A%22Testing%22)

## What is spinningjenny
Forward models and workflows to be used with Ert and Everest

## Download project
The code is hosted on [GitHub](https://github.com/equinor/spinningjenny)

```sh
# Install
pip install git+https://{GH_TOKEN}@github.com/equinor/spinningjenny.git
```

## Run tests
```sh
# Test
pip install --upgrade .[test]
pytest -sv
```

## List of supported workflows:

### add_templates
```bash
usage: add_template [-h] [--lint] [--schemas] -i INPUT -o OUTPUT -c CONFIG

Inserts template file paths for all well operations in the given input file where the config keys match the
operation information. If key sets associated with multiple template files match a well operation the template with
the most keys matching will be the one inserted

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.

required named arguments:
  -i INPUT, --input INPUT
                        Input file that requires template paths. Json file expected ex: wells.json
  -o OUTPUT, --output OUTPUT
                        Output file
  -c CONFIG, --config CONFIG
                        Config file containing list of template file paths to be injected.
```


### drill_date_planner
```bash
usage: drill_date_planner [-h] [--lint] [--schemas] -i INPUT -o OUTPUT -opt OPTIMIZER -b UPPER LOWER -m MAX_DAYS

Calculate and write drill times from scaled controls.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.

required named arguments:
  -i INPUT, --input INPUT
                        Wells file generated by Everest (wells.json).
  -o OUTPUT, --output OUTPUT
                        Output file: input for drill planner job.
  -opt OPTIMIZER, --optimizer OPTIMIZER
                        File containing information related to wells. The format is consistent with the wells.json
                        file when running everest and can be used directly.
  -b UPPER LOWER, --bounds UPPER LOWER
                        Upper and lower bounds of the controls.
  -m MAX_DAYS, --max-days MAX_DAYS
                        Maximum time interval in days.

argument: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase: {required: false, type: string}
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
```


### drill_planner
```bash
drill_planner -i INPUT -c CONFIG -opt OPTIMIZER [-tl TIME_LIMIT] -o OUTPUT [--ignore-end-date]
```

### extract_summary_data
```bash
usage: extract_summary_data [-h] -s SUMMARY -o OUTPUT [--lint] [-sd START_DATE] -ed END_DATE -k KEY [-t {max,diff}]
                            [-m MULTIPLIER]

Module to extract Eclipse Summary keyword data for single date or date interval

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  -sd START_DATE, --start-date START_DATE
                        Start date, if not specified the module will write to the output file a single summary key
                        value for the specified end date
  -t {max,diff}, --type {max,diff}
                        Range calculation type to use (default: diff)
  -m MULTIPLIER, --multiplier MULTIPLIER
                        Result multiplier (default: 1)

required named arguments:
  -s SUMMARY, --summary SUMMARY
                        Ecl summary file
  -o OUTPUT, --output OUTPUT
                        Output file
  -ed END_DATE, --end-date END_DATE, --date END_DATE
                        End date for the summary key interval or date for which to extract a summary key value
  -k KEY, --key KEY     Eclipse summary key
```

### interpret_well_drill
```bash
usage: interpret_well_drill [-h] -i INPUT [--lint] -o OUTPUT

This module transforms dakota well_drill output to a json object.This object contains a list of well names to keep.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.

required named arguments:
  -i INPUT, --input INPUT
                        Yaml file that contains optimizer output, this should consist of a list of well names, with
                        their associated value between 0 and 1
  -o OUTPUT, --output OUTPUT
                        File path to write the resulting json file to.
```

### npv
```bash
npv -s SUMMARY -c CONFIG [-o OUTPUT] [-i INPUT]
  [-sd START_DATE] [-ed END_DATE] [-rd REF_DATE]
  [-ddr DEFAULT_DISCOUNT_RATE] [-der DEFAULT_EXCHANGE_RATE]
  [--multiplier MULTIPLIER]
```

### rf
```bash
rf -s SUMMARY [-pk PRODUCTION_KEY] [-tvk TOTAL_VOLUME_KEY]
             [-sd START_DATE] [-ed END_DATE] [-o OUTPUT]
```

### schmerge
```bash
fm_schmerge -s SCHEDULE -i INPUT -o OUTPUT
```

### select_wells
```bash
usage: select_wells [-h] [--lint] [--schemas] -i INPUT -o OUTPUT [-m MAX_DATE] {value,file} ...

Select the first wells from a drill planner output file.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.
  -m MAX_DATE, --max-date MAX_DATE
                        Maximum allowed date

required named arguments:
  -i INPUT, --input INPUT
                        Input file: a drill planner output file.
  -o OUTPUT, --output OUTPUT
                        Output file: updated drill planner output file

well number:
  Pass the number of wells to be selected as a value or a file path. If neither, then `-m/--max-date` is
  required and the whole list of wells, bounded by the max date, is returned.

  {value,file}
    value               The number of wells as a value
    file                Everest control file containing the number of wells.

argument: file
fields:
   scaled_number_of_wells: {required: true, type: number}
argument: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase: {required: false, type: string}
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
```

### stea
```bash
stea [-c CONFIG]
```


### strip_dates
```bash
usage: strip_dates [-h] -s SUMMARY [--lint] [-d DATE1 [DATE2 ...]] [--allow-missing-dates]

Makes sure a given summary file contains only report steps at the list of dates given as an argument

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  -d DATE1 [DATE2 ...], --dates DATE1 [DATE2 ...]
                        List of date to remain in the summary file (default: [])
  --allow-missing-dates
                        Do not fail if any requested dates are missing in the file

required named arguments:
  -s SUMMARY, --summary SUMMARY
                        Ecl summary file
```


### well_constraints
```bash
usage: well_constraints [-h] [--lint] [--schemas] -i INPUT -o OUTPUT --config CONFIG [--rate-constraints RATE_CONSTRAINTS]
                        [--phase-constraints PHASE_CONSTRAINTS] [--duration-constraints DURATION_CONSTRAINTS]

A module that given a list of boundaries and well constraints creates a list of well events. Varying phase, rate and time of each event is
supported. Rate and duration boundaries are given as min/max, and phase as a list of possibilities to choose from. Will also support constants if boundaries are replaced by value.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.
  --rate-constraints RATE_CONSTRAINTS, -rc RATE_CONSTRAINTS
                        Rate constraints file in json format, from controls section of Everest config, must be indexed format. Values must be in
                        the interval [0, 1], where 0 corresponds to the minimum possible rate value of the well the given index and 1 corresponds
                        to the maximum possible value of the well at the given index.
  --phase-constraints PHASE_CONSTRAINTS, -pc PHASE_CONSTRAINTS
                        Phase constraints file in json format, from controls section of Everest config, must be indexed format. Values must be in
                        the interval [0,1], i.e in a two phase case ["water", "gas"], any control value in the interval [0, 0.5] will be
                        attributed to "water" and any control value in the interval (0.5, 1] will be attributed to "gas".
  --duration-constraints DURATION_CONSTRAINTS, -dc DURATION_CONSTRAINTS
                        Duration constraints file in json format, from controls section of Everest config, must be indexed format. Values must be
                        in the interval [0, 1], where 0 corresponds to the minimum possible drill time for well, if given, 1 corresponds to the
                        maximum drill time of the well if given.

required named arguments:
  -i INPUT, --input INPUT
                        File in json format containing well names and well opening times, should be specified in Everest config (wells.json).
  -o OUTPUT, --output OUTPUT
                        Name of the output file. The format will be yaml.
  --config CONFIG, -c CONFIG
                        Configuration file in yaml format with names, events and boundaries for constraints

---
arguments: --config/-c
fields:
   string:
      integer:
         duration:
            max: {required: false, type: number}
            min: {required: false, type: number}
            value: {required: false, type: number}
         phase:
            options:
            - choices: [water, gas, oil]
              type: string
            value:
               choices: [water, gas, oil]
               type: string
         rate:
            max: {required: false, type: number}
            min: {required: false, type: number}
            value: {required: false, type: number}
...

---
arguments: [--rate-constraints/-rc, --phase-constraints/-pc, --duration-constraints/-dc]
fields:
   string: {integer: float}
...

---
arguments: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase: {required: false, type: string}
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
...
```


### well_filter
```bash
usage: well_filter [-h] [--lint] [--schemas] -i INPUT -o OUTPUT (-k KEEP | -r REMOVE)

This module filters out wells using a json string.Either the --keep or the --remove flag needs to be set to a json
file namecontaining a list of well names that are in the keep/remove file, but not in the input file will be
ignored.If both or none of the flags are set, the job give an error.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.

required named arguments:
  -i INPUT, --input INPUT
                        Json file that contains a list of dictionaries containing well information.
  -o OUTPUT, --output OUTPUT
                        File path to write the resulting wells file to.
  -k KEEP, --keep KEEP  JSON/Y(A)ML file that contains a list of well names to keep.
  -r REMOVE, --remove REMOVE
                        JSON/Y(A)ML file that contains a list of well names to remove.

argument: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase: {required: false, type: string}
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
```





