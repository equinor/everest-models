# spinningjenny 
[![Spinningjenny](https://github.com/equinor/spinningjenny/workflows/Testing/badge.svg)](https://github.com/equinor/spinningjenny/actions?query=workflow%3A%22Testing%22)

## What is spinningjenny
Forward models and workflows to be used with Ert and Everest

## Download project
The code is hosted on [GitHub](https://github.com/equinor/spinningjenny)

```sh
# Install
pip install git+https://{GH_TOKEN}@github.com/equinor/spinningjenny.git
```

## Run tests
```sh
# Test
pip install --upgrade .[test]
pytest -sv
```

## List of supported workflows:

### add_templates
```bash
usage: add_template [-h] [--lint] [--schemas] -i INPUT -o OUTPUT -c CONFIG

Inserts template file paths for all well operations in the given input file where the config keys match the
operation information. If key sets associated with multiple template files match a well operation the template with
the most keys matching will be the one inserted

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.

required named arguments:
  -i INPUT, --input INPUT
                        Input file that requires template paths. Json file expected ex: wells.json
  -o OUTPUT, --output OUTPUT
                        Output file
  -c CONFIG, --config CONFIG
                        Config file containing list of template file paths to be injected.
```


### drill_date_planner
```bash
usage: drill_date_planner [-h] [--lint] [--schemas] -i INPUT -o OUTPUT -opt OPTIMIZER -b UPPER LOWER -m MAX_DAYS

Calculate and write drill times from scaled controls.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.

required named arguments:
  -i INPUT, --input INPUT
                        Wells file generated by Everest (wells.json).
  -o OUTPUT, --output OUTPUT
                        Output file: input for drill planner job.
  -opt OPTIMIZER, --optimizer OPTIMIZER
                        File containing information related to wells. The format is consistent with the wells.json
                        file when running everest and can be used directly.
  -b UPPER LOWER, --bounds UPPER LOWER
                        Upper and lower bounds of the controls.
  -m MAX_DAYS, --max-days MAX_DAYS
                        Maximum time interval in days.

argument: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase: {required: false, type: string}
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
```


### drill_planner
```bash
drill_planner [-h] [--lint] [--schemas] -i INPUT -o OUTPUT -c CONFIG
                       -opt OPTIMIZER [-tl TIME_LIMIT] [--ignore-end-date]

A module that given a well priority list and a set of constraints, creates a
list of dates for each well to be completed. Any well may have multiple
options as to where it can be drilled, both for different slots and rigs. The
module will try to find the optimum event combinations that allows for the
wells to be completed as quickly as possible, and at the same time make sure
that the dates that are output will be a valid drill plan.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data
                        transformation.
  --schemas             Output all file schemas that are taken as input
                        parameters.
  -tl TIME_LIMIT, --time-limit TIME_LIMIT
                        Maximum time limit for the solver in seconds.If a
                        solution has not been reached within this time, a
                        greedyapproach will be used instead. (default: 3600)
  --ignore-end-date     Ignore the end date in the config file.

required named arguments:
  -i INPUT, --input INPUT
                        File containing information related to wells. The
                        format is consistent with the wells.json file when
                        running everest and can be used directly.
  -o OUTPUT, --output OUTPUT
                        Name of the output-file. The output-file (json) will
                        contain the same information as the input-file,
                        including the results from the drill_planner. Please
                        note that it is highly recommended to not use the same
                        filename as the input-file. In cases where the same
                        workflow is run twice, it is generally advised that
                        the input-file for each job is consistent
  -c CONFIG, --config CONFIG
                        Configuration file in yaml format describing the
                        constraints of the field development. The file must
                        contain information about rigs and slots that the
                        wells can be drilled through. Additional information,
                        such as when rigs and slots are available is also
                        added here.
  -opt OPTIMIZER, --optimizer OPTIMIZER
                        The optimizer file in yaml format is the file output
                        from everest that contains the well priority values -
                        a float for each well.

---
arguments: -c/--config
fields:
   end_date: {format: date, required: true, type: string}
   rigs:
   - delay: {required: false, type: integer}
     name: {required: true, type: string}
     slots: [string]
     unavailability:
     - start: {format: date, required: true, type: string}
       stop: {format: date, required: true, type: string}
     wells: [string]
   slots:
   - name: {required: true, type: string}
     unavailability:
     - start: {format: date, required: true, type: string}
       stop: {format: date, required: true, type: string}
     wells: [string]
   start_date: {format: date, required: true, type: string}
...
---
arguments: -opt/--optimizer
fields: {string: float}
...
---
arguments: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase:
       choices: [WATER, GAS, OIL]
       type: string
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
...
```

### extract_summary_data
```bash
usage: extract_summary_data [-h] -s SUMMARY -o OUTPUT [--lint] [-sd START_DATE] -ed END_DATE -k KEY [-t {max,diff}]
                            [-m MULTIPLIER]

Module to extract Eclipse Summary keyword data for single date or date interval

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  -sd START_DATE, --start-date START_DATE
                        Start date, if not specified the module will write to the output file a single summary key
                        value for the specified end date
  -t {max,diff}, --type {max,diff}
                        Range calculation type to use (default: diff)
  -m MULTIPLIER, --multiplier MULTIPLIER
                        Result multiplier (default: 1)

required named arguments:
  -s SUMMARY, --summary SUMMARY
                        Ecl summary file
  -o OUTPUT, --output OUTPUT
                        Output file
  -ed END_DATE, --end-date END_DATE, --date END_DATE
                        End date for the summary key interval or date for which to extract a summary key value
  -k KEY, --key KEY     Eclipse summary key
```

### interpret_well_drill
```bash
usage: interpret_well_drill [-h] -i INPUT [--lint] -o OUTPUT

This module transforms dakota well_drill output to a json object.This object contains a list of well names to keep.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.

required named arguments:
  -i INPUT, --input INPUT
                        Yaml file that contains optimizer output, this should consist of a list of well names, with
                        their associated value between 0 and 1
  -o OUTPUT, --output OUTPUT
                        File path to write the resulting json file to.
```

### npv
```bash
usage: npv [-h] [--lint] [--schemas] -s SUMMARY [-i INPUT]
                       [-o OUTPUT] -c CONFIG [-sd START_DATE] [-ed END_DATE]
                       [-rd REF_DATE] [-ddr DEFAULT_DISCOUNT_RATE]
                       [-der DEFAULT_EXCHANGE_RATE] [--multiplier MULTIPLIER]

Module to calculate the NPV based on an eclipse simulation. All optional args,
except: lint, schemas, input and output, is also configurable through the
config file.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data
                        transformation.
  --schemas             Output all file schemas that are taken as input
                        parameters.
  -i INPUT, --input INPUT
                        Path to input file containing information related to
                        wells. The format is consistent with the wells.json
                        file when running everest. It must contain a
                        'readydate' key for each well for when it is
                        considered completed and ready for production.
  -o OUTPUT, --output OUTPUT
                        Path to output-file where the NPV result is written
                        to. (default: npv_0)
  -sd START_DATE, --start-date START_DATE
                        Start point of NPV calculation as ISO8601 formatted
                        date (YYYY-MM-DD).
  -ed END_DATE, --end-date END_DATE
                        End point of NPV calculation as ISO8601 formatted date
                        (YYYY-MM-DD).
  -rd REF_DATE, --ref-date REF_DATE
                        Ref point of NPV calculation as ISO8601 formatted date
                        (YYYY-MM-DD).
  -ddr DEFAULT_DISCOUNT_RATE, --default-discount-rate DEFAULT_DISCOUNT_RATE
                        Default discount rate you want to use.
  -der DEFAULT_EXCHANGE_RATE, --default-exchange-rate DEFAULT_EXCHANGE_RATE
                        Default exchange rate you want to use.
  --multiplier MULTIPLIER
                        Multiplier you want to use.

required named arguments:
  -s SUMMARY, --summary SUMMARY
                        Ecl summary file
  -c CONFIG, --config CONFIG
                        Path to config file containing at least prices
arguments: -c/--config
fields:
   costs:
   - currency: {required: false, type: string}
     date: {format: date, required: true, type: string}
     value: {required: true, type: number}
   dates:
      end_date: {format: date, required: false, type: string}
      ref_date: {format: date, required: false, type: string}
      start_date: {format: date, required: false, type: string}
   default_discount_rate: {default: 0.08, required: false, type: number}
   default_exchange_rate: {default: 1, required: false, type: number}
   discount_rates:
   - currency: {required: false, type: string}
     date: {format: date, required: true, type: string}
     value: {required: true, type: number}
   exchange_rates:
      string:
      - currency: {required: false, type: string}
        date: {format: date, required: true, type: string}
        value: {required: true, type: number}
   multiplier: {default: 1, required: false, type: number}
   prices:
      string:
      - currency: {required: false, type: string}
        date: {format: date, required: true, type: string}
        value: {required: true, type: number}
   summary_keys: [string]
   well_costs:
   - currency: {required: false, type: string}
     value: {required: true, type: number}
     well: {required: true, type: string}
...
---
arguments: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase:
       choices: [WATER, GAS, OIL]
       type: string
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
...
```

### rf
```bash
usage: rf [-h] -s SUMMARY [--lint] [-o OUTPUT]
                       [-pk PRODUCTION_KEY] [-tvk TOTAL_VOLUME_KEY]
                       [-sd START_DATE] [-ed END_DATE]

Calculates the recovery factor given summary keys and dates. Requires an
EclSum instance to retrieve the volumes from. The summary keys requested must
be in the EclSum instance. If the dates are outside the simulation range, they
will be clamped to nearest. Will throw an error if the entire date range is
outside the simulation range.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data
                        transformation.
  -o OUTPUT, --output OUTPUT
                        Filename of the output file.
  -pk PRODUCTION_KEY, --production_key PRODUCTION_KEY
                        Production key - a valid summary key (default: FOPT)
  -tvk TOTAL_VOLUME_KEY, --total_volume_key TOTAL_VOLUME_KEY
                        Total volume key - a valid summary key (default: FOIP)
  -sd START_DATE, --start_date START_DATE
                        Start date - As ISO8601 formatted date (YYYY-MM-DD)
  -ed END_DATE, --end_date END_DATE
                        Start date - As ISO8601 formatted date (YYYY-MM-DD)

required named arguments:
  -s SUMMARY, --summary SUMMARY
                        Ecl summary file
```

### schmerge
```bash
usage: fm_schmerge [-h] [--lint] [--schemas] -s SCHEDULE -i INPUT -o
                       OUTPUT

This module works on a schedule file intended for reservoir simulation(e.g.
eclipse or flow), and injects templates at given dates. If the reportdate does
not exist in advance it will be added as an independent step. The templates
will further be filled in with the given parameter values.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data
                        transformation.
  --schemas             Output all file schemas that are taken as input
                        parameters.

required named arguments:
  -s SCHEDULE, --schedule SCHEDULE
                        Schedule file to inject templates into. The only
                        currently accepted date format is the following: one
                        line consisting of the DATES keyword, followed by a
                        date in the format of '1 JAN 2000' terminated by a
                        slash. The final line consists of a slash. An empty
                        line should be in between the date format and anything
                        below.
  -i INPUT, --input INPUT
                        Json file that specifies which templates to inject
                        where.The file is structured as a list of
                        dictionaries, each containing information regarding
                        one well. The name defines the name of the well, and
                        the ops is a list of operations to be performed on the
                        well. The operations are defined within a dict with
                        the required keys template, date and any parameter
                        values that are to be injected into the given template
  -o OUTPUT, --output OUTPUT
                        File path to write the resulting schedule file to.
---
arguments: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase:
       choices: [WATER, GAS, OIL]
       type: string
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
...
```

### select_wells
```bash
usage: select_wells [-h] [--lint] [--schemas] -i INPUT -o OUTPUT [-m MAX_DATE] {value,file} ...

Select the first wells from a drill planner output file.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.
  -m MAX_DATE, --max-date MAX_DATE
                        Maximum allowed date

required named arguments:
  -i INPUT, --input INPUT
                        Input file: a drill planner output file.
  -o OUTPUT, --output OUTPUT
                        Output file: updated drill planner output file

well number:
  Pass the number of wells to be selected as a value or a file path. If neither, then `-m/--max-date` is
  required and the whole list of wells, bounded by the max date, is returned.

  {value,file}
    value               The number of wells as a value
    file                Everest control file containing the number of wells.

argument: file
fields:
   scaled_number_of_wells: {required: true, type: number}
argument: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase: {required: false, type: string}
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
```

### stea
```bash
stea [-c CONFIG]
```


### strip_dates
```bash
usage: strip_dates [-h] -s SUMMARY [--lint] [-d DATE1 [DATE2 ...]] [--allow-missing-dates]

Makes sure a given summary file contains only report steps at the list of dates given as an argument

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  -d DATE1 [DATE2 ...], --dates DATE1 [DATE2 ...]
                        List of date to remain in the summary file (default: [])
  --allow-missing-dates
                        Do not fail if any requested dates are missing in the file

required named arguments:
  -s SUMMARY, --summary SUMMARY
                        Ecl summary file
```


### well_constraints
```bash
usage: well_constraints [-h] [--lint] [--schemas] -i INPUT -o OUTPUT --config CONFIG [--rate-constraints RATE_CONSTRAINTS]
                        [--phase-constraints PHASE_CONSTRAINTS] [--duration-constraints DURATION_CONSTRAINTS]

A module that given a list of boundaries and well constraints creates a list of well events. Varying phase, rate and time of each event is
supported. Rate and duration boundaries are given as min/max, and phase as a list of possibilities to choose from. Will also support constants if boundaries are replaced by value.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.
  --rate-constraints RATE_CONSTRAINTS, -rc RATE_CONSTRAINTS
                        Rate constraints file in json format, from controls section of Everest config, must be indexed format. Values must be in
                        the interval [0, 1], where 0 corresponds to the minimum possible rate value of the well the given index and 1 corresponds
                        to the maximum possible value of the well at the given index.
  --phase-constraints PHASE_CONSTRAINTS, -pc PHASE_CONSTRAINTS
                        Phase constraints file in json format, from controls section of Everest config, must be indexed format. Values must be in
                        the interval [0,1], i.e in a two phase case ["water", "gas"], any control value in the interval [0, 0.5] will be
                        attributed to "water" and any control value in the interval (0.5, 1] will be attributed to "gas".
  --duration-constraints DURATION_CONSTRAINTS, -dc DURATION_CONSTRAINTS
                        Duration constraints file in json format, from controls section of Everest config, must be indexed format. Values must be
                        in the interval [0, 1], where 0 corresponds to the minimum possible drill time for well, if given, 1 corresponds to the
                        maximum drill time of the well if given.

required named arguments:
  -i INPUT, --input INPUT
                        File in json format containing well names and well opening times, should be specified in Everest config (wells.json).
  -o OUTPUT, --output OUTPUT
                        Name of the output file. The format will be yaml.
  --config CONFIG, -c CONFIG
                        Configuration file in yaml format with names, events and boundaries for constraints

---
arguments: --config/-c
fields:
   string:
      integer:
         duration:
            max: {required: false, type: number}
            min: {required: false, type: number}
            value: {required: false, type: number}
         phase:
            options:
            - choices: [water, gas, oil]
              type: string
            value:
               choices: [water, gas, oil]
               type: string
         rate:
            max: {required: false, type: number}
            min: {required: false, type: number}
            value: {required: false, type: number}
...

---
arguments: [--rate-constraints/-rc, --phase-constraints/-pc, --duration-constraints/-dc]
fields:
   string: {integer: float}
...

---
arguments: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase: {required: false, type: string}
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
...
```


### well_filter
```bash
usage: well_filter [-h] [--lint] [--schemas] -i INPUT -o OUTPUT (-k KEEP | -r REMOVE)

This module filters out wells using a json string.Either the --keep or the --remove flag needs to be set to a json
file namecontaining a list of well names that are in the keep/remove file, but not in the input file will be
ignored.If both or none of the flags are set, the job give an error.

optional arguments:
  -h, --help            show this help message and exit
  --lint                Lints all given input (file) arguments with no data transformation.
  --schemas             Output all file schemas that are taken as input parameters.

required named arguments:
  -i INPUT, --input INPUT
                        Json file that contains a list of dictionaries containing well information.
  -o OUTPUT, --output OUTPUT
                        File path to write the resulting wells file to.
  -k KEEP, --keep KEEP  JSON/Y(A)ML file that contains a list of well names to keep.
  -r REMOVE, --remove REMOVE
                        JSON/Y(A)ML file that contains a list of well names to remove.

argument: -i/--input
fields:
- completion_date: {format: date, required: false, type: string}
  drill_time: {required: false, type: integer}
  name: {required: true, type: string}
  ops:
  - date: {format: date, required: true, type: string}
    opname: {required: true, type: string}
    phase: {required: false, type: string}
    rate: {required: false, type: number}
    template: {format: file-path, required: false, type: string}
  readydate: {format: date, required: false, type: string}
```





